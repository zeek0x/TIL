# awk コマンド

## 基本的な構文

[とほほのAWK入門](https://www.tohoho-web.com/ex/awk.html)が参照しやすくてよい。

## Tips

正規表現を扱える。

```console
$ seq 5 | awk '/[24]/'
2
4
```

検索対象の列に対しての計算結果を評価することができる。`awk`コマンドでは読み込んだ行に対して区切り文字（デフォルトではスペース、`-F`オプションで指定可能）によって列として認識される。`$1`は「読み込んだ行の１列目の文字列」を意味している。2列目以降は、`$2`, `$3`, ...というように扱うことができる。

```console
$ seq 5 | awk '$1%2==0'
2
4
```

検索にマッチした行に処理を加えることができる。`printf`は引数にテンプレートと埋め込む値を引数にとり、フォーマットされた文字列を出力する。また、引数を表示するだけの`print`を使って`print $1,"偶数"`のように書いても良い。

```console
$ seq 5 | awk '$1%2==0{printf("%s 偶数\n",$1)}'
2 偶数
4 偶数
```

非ゼロの値は真と評価するので２つ目のルールは表記を省略している。

```console
$ seq 5 | awk '$1%2==0{print $1, "偶数"}$1%2{print $1,"奇数"}'
1 奇数
2 偶数
3 奇数
4 偶数
5 奇数
```

`BEGIN`、`END`はそれぞれBEGINパターン、ENDパターンと呼ばれ、それぞれ「`awk`が１行目の処理を始める前」、「`awk`が最終行の処理を終えた後」という状況にマッチする。`awk`の変数を宣言せずとも`0`で初期化されるので、この例の`BEGIN{a=0}`の部分は省略可能である。

```console
$ seq 5 | awk 'BEGIN{a=0}%1%2==0{print %1,"偶数"}%1%2{print %1,"奇数"}{a+=$1}END{print "合計", a}'
seq 5 | awk 'BEGIN{a=0}$1%2==0{print $1,"偶数"}$1%2{print $1,"奇数"}{a+=$1}END{print "合計", a}'
1 奇数
2 偶数
3 奇数
4 偶数
5 奇数
合計 15
```

現在の行のフィールド数（`NF`(Number of Fileds)変数）・レコード番号（`NR`(Number of Records)変数）を扱える。

```console
$ cat <<EOF | awk 'NF > 1'
1
2 3
4 5 6
EOF
2 3
4 5 6
$ seq 5 | awk 'NR > 2'
3
4
5
```

日付のようなフォーマットは、文字列比較で扱えるケースがある。

```console
$ cat log.txt
192.168.0.2 Wake up. [01/Dec/2021 07:23:45]
192.168.0.3 Breakfast. [01/Dec/2021 07:45:18]
192.168.0.4 Ready to go out. [01/Dec/2021 08:12:04]
192.168.0.5 I'm going. [01/Dec/2022 08:33:35]
192.168.0.6 Arrive at the office. [01/Dec/2021 09:05:41]
192.168.0.7 Start to work. [01/Dec/2021 09:28:01]
192.168.0.8 Lunch. [01/Dec/2021 12:29:22]
192.168.0.9 Finish to work. [01/Dec/2021 18:43:31]
192.168.0.10 Head home. [01/Dec/2021 18:52:13]
192.168.0.11 Arrive home. [01/Dec/2021 19:24:06]
192.168.0.12 Dinner. [01/Dec/2021 20:26:42]
192.168.0.13 Take a bath. [01/Dec/2021 21:30:46]
192.168.0.14 Go to Bed. [01/Dec/2021 23:51:58]
$ cat log.txt | awk '{t_str=$(NF-1)" "$(NF); if ("[01/Dec/2021 09:00:00]"<=t_str && t_str <="[01/Dec/2021 16:59:59]") print $0}'
192.168.0.6 Arrive at the office. [01/Dec/2021 09:05:41]
192.168.0.7 Start to work. [01/Dec/2021 09:28:01]
192.168.0.8 Lunch. [01/Dec/2021 12:29:22]
```

`awk` 内から外部コマンドを扱える。

```console
$ cat a.txt
2022-01-01
2022-02-01
2022-03-01
$ cat a.txt | awk '{"date -d \""$1" +6 day\" \"+%F %a\"" | getline t; print t}'
2022-01-07 金
2022-02-07 月
2022-03-07 月
```

リダイレクトを用いてファイルに書き込むことができる。

```console
$ seq 5 | awk '{print $0 > ($0%2?"odd":"even")}'
$ cat odd
1
3
5
$ cat even
2
4
```

`yes` コマンドと組み合わせるとループとインクリメントの処理が楽にかける。

```console
$ yes | awk '{print NR}10<NR{exit}'
1
2
3
4
5
6
7
8
9
10
11
```

## 参考

[1日1問、半年以内に習得 シェル・ワンライナー160本ノック](https://gihyo.jp/book/2021/978-4-297-12267-6)
